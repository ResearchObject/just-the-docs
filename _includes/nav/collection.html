{%- comment -%}
  {%- include nav/collection.html 
        pages = array
        key = name_or_nil -%}
  outputs the main navigation links for `pages`. It also assigns arrays of pages
  to variables inspected by `nav/crumbs` and `nav/toc`.
  
  When `key` is `nil`, `pages` is `site.html_pages`; otherwise `key` is the name
  of a collection, and `pages` are the pages of that collection. (Pages without
  a `title` are automatically excluded in the former case, but Jekyll provides
  default titles for pages in collections, so their untitled pages are not
  automatically excluded.)
  
  `collection` first groups `pages` by their `parent` fields, creating an array
  of hashes. It then creates `nav_parenthood` by sorting the items of each hash.
  (Sorting pages before grouping them would be simpler, but less efficient on
  larger sites.)
  
  When `pages` contains the current page, `collection` then calls `nav/page`
  to search for the navigation path to that page, thereby assigning:
  - a string of numerical navigation indices leading to `nav_page_path`,
  - an array of ancestors of `page` to `nav_page_ancestors`, and
  - an array of children of `page` to `nav_page_children`.
  When pages are stored in folders whose nesting corresponds to the parent
  relation, only nodes whose folder path is a prefix of `page.path` need to be
  searched. For larger sites, using folder paths to direct searching for `page`
  can significantly reduce the build time. To avoid dependence on assumptions
  about the folders used to store pages, however, exhaustive search is needed
  as a fall-back when directed search fails.
  
  Finally, `collection` outputs the main navigation links for `pages`. When the
  display of the links depends on the page, it is generated by `nav/links`;
  otherwise it is generated by `nav/inactive_links`, and cached. (The presence
  of navigation expanders requires the navigation for the entire site to be
  output on every page, and caching the generated links for the page-independent
  parts of it can signficantly reduce the build time for larger sites.)
{%- endcomment -%}

{%- assign nav_nodes = include.pages | where_exp: "item", "item.title != nil "-%}

{%- assign nav_parenthood_unsorted = nav_nodes | group_by: "parent" -%}
{%- assign nav_parenthood = "" | split: "X" -%}
{%- for nav_group in nav_parenthood_unsorted -%}
  {%- include nav/sorted.html
        nodes = nav_group.items -%}
  {%- assign nav_group_sorted = nav_sorted | group_by: "parent" | first -%}
  {%- assign nav_parenthood = nav_parenthood | push: nav_group_sorted -%}
{%- endfor -%}

{%- assign nav_top_nodes = nav_parenthood
      | where_exp: "item", "item.name == ''" | map: "items" | first -%}

{%- assign nav_ancestors = "" | split: "X" -%}

{%- if include.key == nil or include.key == page.collection -%}

  {%- assign nav_page_dir = page.path | split: "/" | pop | join: "/" -%}

  {%- assign nav_direct = true -%}
  {%- include nav/page.html 
        nodes = nav_top_nodes
        ancestors = nav_ancestors
        path = "^"
        in_section = nil -%}

  {%- unless nav_page_path -%}
    {%- assign nav_direct = false -%}
    {%- include nav/page.html 
          nodes = nav_top_nodes
          ancestors = nav_ancestors
          path = "^"
          in_section = nil -%}
  {%- endunless -%}

  {%- include nav/links.html
        nodes = nav_top_nodes
        ancestors = nav_ancestors
        path = "^" 
        in_section = nil
        page_path = nav_page_path
        parenthood = nav_parenthood -%}

{%- else -%}

  {%- include_cached nav/inactive_links.html 
      nodes = nav_top_nodes 
      ancestors = nav_ancestors 
      in_section = nil
      parenthood = nav_parenthood -%}

{%- endif -%}
